<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Furata-style Inverted Pendulum — Your Name</title>
  <meta name="description" content="Modelling, identification, and control of a Furata-style inverted pendulum (Quanser QUBE)." />
  <link rel="stylesheet" href="../assets/css/style.css" />

  <!-- MathJax config -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        tags: 'none'
      },
      options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] }
    };
  </script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
</head>
<body>
  <header class="site-header">
    <div class="container nav">
      <a class="brand" href="../">Your Name</a>
      <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">☰</button>
      <nav class="nav-links" data-collapsible>
        <a href="../">Home</a>
        <a href="./">Projects</a>
        <a href="../assets/cv/placeholder.txt">CV</a>
        <a href="https://www.linkedin.com/in/your-handle" target="_blank" rel="noopener">LinkedIn</a>
        <a href="https://github.com/your-handle" target="_blank" rel="noopener">GitHub</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <article class="post">
      <h1>Furata-style Inverted Pendulum — Modelling, Identification, Control</h1>
      <p><strong>Authors:</strong> Kosma Krzyżanowski, Áron Dömötör Kohlhéb</p>
      <p><strong>Hardware:</strong> Quanser QUBE Furata Pendulum, courtesy of Delft Centre for Systems and Control at the TU Delft</p>
      <p><strong>Goal:</strong> Swing up and control the pendulum at its unstable equilibrium.</p>
      <p><strong>Demonstration of the controllers' performance</strong> <a href="https://youtu.be/A2EXIjPWqo4" target="_blank" rel="noopener">VIDEO</a></p>

      <h2>Modelling</h2>
      <p>The rotary pendulum is derived with the <strong>principle of least action</strong>.<br>
      Generalised coordinates \(q=[\theta,\alpha]^{\!\top}\), with angles defined as in:</p>
      <p><img src="../img/plots/sketch.png" alt="alpha_val"></p>

      <h3>1. Lagrangian</h3>
      <div class="equation">\( L = T_0 + T_1 - V_0 - V_1 \)</div>
      <p>with \(V_0=0\),</p>
      <div class="equation">
        \( V_1 = \tfrac12\,L_1 m_1 g \cos\alpha, \qquad
        T_0 = \tfrac12\,J_0\,\dot\theta^{2}, \)
      </div>
      <div class="equation">
        \( T_1 = \tfrac12 \frac{m_1}{L_1}\int_{0}^{L_1} v_s^{T}v_s\,ds \tag{1} \)
      </div>

      <h3>2. Kinematics of a rod slice</h3>
      <div class="equation">
        \( P_s = L_0
              \begin{pmatrix}\cos\theta\\\sin\theta\\0\end{pmatrix}
            + s
              \begin{pmatrix}
                 \sin\alpha\sin\theta\\
                -\sin\alpha\cos\theta\\
                 \cos\alpha
              \end{pmatrix},
        \qquad
        v_S = \dot P_s
             = \frac{\partial P_s}{\partial\theta}\dot\theta
             + \frac{\partial P_s}{\partial\alpha}\dot\alpha . \)
      </div>

      <h3>3. Quadratic kinetic energy</h3>
      <p>After integration:</p>
      <div class="equation">
        \( T_1 = \tfrac12\, m_1L_1^{2}\,
              \dot q^{\!\top} M(\alpha)\, \dot q, \)
      </div>
      <div class="equation">
        \( M(\alpha)=
        \begin{pmatrix}
          r^{2}C_0^{\!\top}C_0 + rC_0^{\!\top}C_1 + \tfrac13 C_1^{\!\top}C_1 &
          \tfrac12 rC_0^{\!\top}C_2 + \tfrac13 C_1^{\!\top}C_2 \\[6pt]
          \tfrac12 rC_0^{\!\top}C_2 + \tfrac13 C_1^{\!\top}C_2 &
          \tfrac13 C_2^{\!\top}C_2
        \end{pmatrix},
        \quad r=\tfrac{L_0}{L_1}. \)
      </div>
      <div class="equation">
        \( \left( \begin{matrix}
                C_0 & C_1 & C_2
            \end{matrix} \right)   =
                \left(\begin{matrix}
                -\sin(\theta) &   \sin(\alpha) \cos(\theta) & \cos(\alpha) \sin\theta) \\
                \cos(\theta) & \sin(\alpha) \sin(\theta) &  - \cos(\alpha) \cos(\theta) \\
                0 &  0 &- \sin(\alpha)
            \end{matrix} \right) \)
      </div>

      <h3>4. Equations of motion</h3>
      <p>Euler–Lagrange gives</p>
      <div class="equation">
        \( \frac{1}{ L_1^2 m_1}
            \left( \begin{matrix}
                \tau_{\theta} \\
                \tau_{\alpha}
            \end{matrix} \right)
            = \left( \begin{matrix}
                -k1 & 0 \\ -k_2 & -k_3
            \end{matrix}\right)
            \left( \begin{matrix}
                \dot \theta \\ \dot \alpha
            \end{matrix}\right)
            +
            \left( \begin{matrix}
            -k_4 & 0 \\ 0 & 0
            \end{matrix}\right)
            \left( \begin{matrix}
            \theta \\ \alpha
            \end{matrix}\right)
            +
            \left( \begin{matrix}
            k_5 \\ 0
            \end{matrix}\right)
            V \)
      </div>

      <h3>5. Linearised state-space (hanging)</h3>
      <div class="equation">
        \( \begin{pmatrix}
        \ddot\theta\\\ddot\alpha\\\dot\theta\\\dot\alpha
        \end{pmatrix}=
        \begin{pmatrix}
        A_{11}&A_{12}\\ I&0
        \end{pmatrix}
        \begin{pmatrix}
        \dot\theta\\\dot\alpha\\\theta\\\alpha
        \end{pmatrix}+
        \begin{pmatrix}B_1\\0\end{pmatrix}V, \)
      </div>
      <div class="equation">
        \( A_{11}=\bar M^{-1}
          \begin{pmatrix}-k_1&0\\-k_2&-k_3\end{pmatrix},\quad
        A_{12}=\bar M^{-1}
          \begin{pmatrix}-k_4&0\\0&k_5\end{pmatrix},\quad
        B_1=\bar M^{-1}\begin{pmatrix}k_6\\0\end{pmatrix}. \)
      </div>
      <p>The model linearised at the downward equilibrium is used for identification. Using the identified model at the unstable equilibrium is easy as only requires some sign flips in the state space model.</p>

      <h2>Identification</h2>
      <p>With the obtained dynamics model of the system, missing parameters were identified. For that the MATLAB grey-box identification was used. In order to ensure persistent excitation of the system, an input signal, made up of frequency-sweep, sine, square and sawtooth signals was used. The identified model was then validated on a different combination of constituent signals with frequencies in the range 0.5 - 4&nbsp;Hz. The results can be seen in:</p>
      <p><img src="/irrelevant/report/figures/output2_alpha.jpg" alt="alpha_val"><br>
      Identified model response vs actual of the \(\alpha\) angle</p>
      <p><img src="/irrelevant/report/figures/output2_theta.jpg" alt="theta_val"><br>
      Identified model response vs actual of the \(\theta\) angle</p>

      <p>With the following performance:</p>
      <table>
        <thead>
          <tr>
            <th><strong>Output</strong></th>
            <th><strong>VAF (%)</strong></th>
            <th><strong>RMSE</strong></th>
          </tr>
        </thead>
        <tbody>
          <tr><td>θ</td><td>73.18</td><td>0.0217</td></tr>
          <tr><td>α</td><td>85.56</td><td>0.0137</td></tr>
        </tbody>
      </table>

      <h2>Observer</h2>
      <p>Two of the states are available directly via measurements: \(\theta\) and \(\alpha\), the two angles, which correspond to the 3rd and 4th states: \(x(3), x(4)\). The states left to be determined are the angular accelerations \(\dot \theta\) and \(\dot \alpha\) which correspond to \(x(1)\) and \(x(2)\). Since the dynamics is available in this process it is exploited such that the measurements tell us the values of the missing states via the Lundberg observer. While using this observer the following dynamics describes the evolution of the error:</p>

      <div class="equation">
        \[
            e_{k+1} = (A - LC) e_k
        \]
      </div>

      <p>This simple, separated form of the error dynamics allows for a simple design of the observer via the pole placement of the present autonomous system. Since the controllers are designed in discrete time the observer is also designed in discrete time, meaning that the poles of the error dynamics need to be contained in the unit circle in order to drive the error to zero.</p>

      <h2>Stabilising Controllers</h2>
      <p>Two stabilising controllers were implemented: Linear Quadratics Regulator and Model Predictive Controller.</p>

      <h3>Linear Quadratic Regulator</h3>
      <p><strong>See:</strong> <a href="https://youtu.be/A2EXIjPWqo4" target="_blank" rel="noopener">VIDEO</a></p>
      <p>An LQR controller with an integrator on the theta angle was implemented. It was found that gains Q=[0 0 7 0] and R = 100 resulted in a very well performing controller in terms of reference tracking and disturbance rejection. The gains correspond to penalising the value \(\theta\) diverging from the reference and the control input.</p>

      <h3>Model Predictive Control</h3>
      <p><strong>see:</strong> <a href="https://youtu.be/A2EXIjPWqo4" target="_blank" rel="noopener">VIDEO</a></p>
      <p>In order to implement MPC, the <strong>heavy algebra of MPC is pre-computed off-line</strong>.<br>
      First an ellipsoidal terminal set</p>
      <div class="equation">\( \mathcal X_f = \{\,x \mid x^{\!\top}P x \le a\} \)</div>
      <p>is chosen so that the Lyapunov-decrease inequality</p>
      <div class="equation">\( (A-BK)^{\!\top}P(A-BK)-P+Q+K^{\!\top}R K \preceq 0 \)</div>
      <p>holds; inside \(\mathcal X_f\) the invariant LQR law \(u=-Kx\) guarantees stability.<br>
      With \(P,a\) fixed, the finite-horizon cost is expanded once into the quadratic form</p>
      <div class="equation">
        \( \frac12\,u^{\!\top} H u ,\qquad
        H = S_u^{\!\top}\,\bar Q\,S_u + \bar R, \)
      </div>
      <p>and the input/state limits are collected in the static inequalities \(F u \le h\).</p>
      <p><strong>On-line, each sampling instant</strong> we update only the linear term that depends on the current state and solve the quadratic programme</p>
      <div class="equation">
        \( \min_{u}\;\tfrac12 u^{\!\top} H u \quad\text{s.t.}\quad F u \le h, \)
      </div>
      <p>using a fast QP solver.<br>
      Because \(H,F,h\) were pre-computed, the real-time step reduces to one small quadratic optimization problem.</p>

      <p>An MPC was implemented and found to work well with the same Q and R matrices as in LQR, with matrix P found through the solution of the Disrete Algebraic Riccati Solution. A constraint on the input was used. Other constraints were found to significantly diminish performance.</p>
      <p>Different values were chosen for the horizon length. It was found that above a horizon of N=30, the controller did not work, while for horizon values in the range \(N \in [2,30]\), the controller behaved well and very similrly to LQR​. The only difference was that for higher values of N, there was less overshoot.</p>

      <h3>Comparison</h3>
      <p><strong>See:</strong> <a href="https://youtu.be/A2EXIjPWqo4" target="_blank" rel="noopener">VIDEO</a></p>
      <p>The performance of the controllers was compared. First on a sine reference input:</p>
      <p><img src="../img/plots/controllers/lqr_mpc_sine.jpg" alt="lqr vs mpc — sine"></p>
      <p>Secondly on a trapezoidal wave.</p>
      <p><img src="../img/plots/controllers/lqr_mpc_step_limiter.jpg" alt="lqr vs mpc — trapezoid"></p>
      <p>The performance of the two controllers was very similar. That is to be expected as when the actual state stays inside the region where the linear model is accurate, the MPC optimisation reduces to the same Riccati solution used by the LQR. In that situation the last predicted state is inside the MPC’s terminal set, so the optimal feedback law that MPC applies at each step is the LQR gain.</p>

      <h2>Swing up</h2>
      <p><strong>See:</strong> <a href="https://youtu.be/A2EXIjPWqo4" target="_blank" rel="noopener">VIDEO</a></p>
      <p>In order to design a swing up controller, an <strong>"Energy pumping"</strong> approach from the paper by Åström and Furuta (2000)<span>[1]</span> is used. The idea is to implement a control law, that increases the energy of the pendulum, until it is equal the potential energy of the stationary pendulum at the unstable equlibrium.</p>

      <h3>1&nbsp; Energy model used on-line</h3>
      <p>From model the model of the system, the <strong>instantaneous mechanical energy relative to the upright</strong> is computed.</p>
      <div class="equation">
        \( E(\boldsymbol x)=
        \tfrac12\,\dot\theta^{2}J_{0}+
        \tfrac12\,m_{1}L_{1}^{2}\,[\dot\theta,\dot\alpha]
        M(\theta,\alpha)\,[\dot\theta,\dot\alpha]^T+
        m_{1}gL_{1}\bigl[\cos\alpha-1\bigr]. \)
      </div>
      <p>The <strong>desired energy</strong> for exactly balancing at the top is \(E_{\!d}=0\).</p>

      <h3>2&nbsp; Energy-shaping control law</h3>
      <p>Following Eq. (5) in Åström &amp; Furuta the time derivative of the energy is directly proportional to the torque/voltage product</p>
      <div class="equation">
        \(\boxed{%
        \dot E =
        \underbrace{m_1 L_1 \dot\theta \cos\alpha}_{\psi(\boldsymbol x)}
        \;
        \underbrace{\frac{K_t}{R_m}\bigl(V-K_e\dot\theta\bigr)}_{\tau/m_1L_1}}\)
      </div>
      <p>Hence</p>
      <ul>
        <li><strong>\(\psi(\boldsymbol x)=\dot\theta\cos\alpha\)</strong> gives the <em>state-dependent</em> factor.</li>
        <li><strong>\(V-K_e\dot\theta\)</strong> (voltage minus back-EMF) gives the <em>control-dependent</em> factor.</li>
      </ul>
      <p><code>sign(ψ) · sign(V − K_e ẏθ)</code> therefore decides whether \(\dot E\) is positive, (energy pumped in) or negative (energy extracted). An assumption is made that the velocities are relatively small, and so <code>sign(ψ)</code> is enough to control whether the energy is added or subtracted from the system.</p>
      <p>The control strategy is obtained through the Lyapunov method, with Lyapunov function:</p>
      <div class="equation">\( W = (E-E_d)^2/2 \)</div>
      <p>Leading to the input voltage equation, with saturation voltage limits of the pendulum motor:</p>
      <div class="equation">
        \(\boxed{\,%
        V(t)=\operatorname{sat}_{V_{\text{max}}}
        \!\Bigl(
        k_E\,[E(\boldsymbol x)-E_d]\;\operatorname{sgn}\!\bigl[\psi(\boldsymbol x)\bigr]
        \Bigr)\,}\)
      </div>

      <h3>3&nbsp; Transition to linear control</h3>
      <p>The control strategy guarantees \(\displaystyle\lim_{t\to t_\star}E(t)=0\), the swing reaches a <strong>small-angle neighbourhood</strong><br>
      \(|\alpha|\!<\!0.1\text{ rad},\; |\dot\alpha|\!<\!0.2\text{ rad/s}\) where the linearised model is valid.<br>
      A <strong>handover flag</strong></p>
      <div class="equation">
        \( \mathsf{catch}=
        \bigl(|\alpha|<\alpha_{\text{th}} \;\land\; |\dot\alpha|<\dot\alpha_{\text{th}}\bigr) \)
      </div>
      <p>switches from the energy controller into the LQR controller and <strong>resets a discrete-time Luenberger observer</strong> with the measured angles as initial state.</p>

      <h3>4&nbsp; Behaviour obtained</h3>
      <p>The kinetic energy of the pendulum increases monotonically in around 5 seconds.</p>

      <h2>References</h2>
      <p>[1] K. J. Åström and K. Furuta, “Swinging up a pendulum by energy control,” <em>Automatica</em>, vol. 36, no. 2, pp. 287–295, Feb. 2000. DOI: 10.1016/S0005-1098(99)00140-5.</p>

      <p>
        <a class="btn small" href="./">← Back to projects</a>
      </p>
    </article>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>© <span id="year"></span> Your Name.</small>
    </div>
  </footer>

  <script src="../assets/js/main.js" defer></script>
</body>
</html>
